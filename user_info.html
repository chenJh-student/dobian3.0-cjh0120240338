NEW_FILE_CODE
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户中心 - 豆瓣电影</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f0f3f5;
        }

        #app {
            min-height: 100vh;
        }

        .user-profile-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .loading-container,
        .error-container {
            text-align: center;
            padding: 40px 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .profile-header {
            display: flex;
            gap: 30px;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .avatar-section {
            flex: 0 0 150px;
        }

        .user-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #37a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 60px;
            font-weight: bold;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 28px;
            margin: 0 0 20px 0;
            color: #333;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #37a;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .section-title {
            font-size: 20px;
            color: #333;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .movies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .movie-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .movie-card:hover {
            transform: translateY(-5px);
        }

        .movie-poster {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .movie-title {
            padding: 10px;
            text-align: center;
            font-size: 14px;
            color: #333;
        }

        .back-button {
            padding: 10px 20px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .logout-button {
            padding: 10px 20px;
            background-color: #666;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .back-button:hover,
        .logout-button:hover {
            opacity: 0.9;
        }

        .actions {
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                align-items: center;
            }

            .user-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="user-profile-page">
            <div v-if="loading" class="loading-container">
                <div class="spinner"></div>
                <p>加载中...</p>
            </div>

            <div v-else-if="error" class="error-container">
                <p>{{ error }}</p>
                <button @click="goBack" class="back-button">返回首页</button>
                <button @click="retry" class="back-button">重试</button>
            </div>

            <div v-else-if="user" class="user-profile">
                <div class="profile-header">
                    <div class="avatar-section">
                        <div class="user-avatar">{{ user.username.charAt(0) }}</div>
                    </div>

                    <div class="user-info">
                        <h1 class="user-name">{{ user.username }}</h1>

                        <div class="user-stats">
                            <div class="stat-item">
                                <div class="stat-number">{{ watchedCount }}</div>
                                <div class="stat-label">已看电影</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">{{ wantToWatchCount }}</div>
                                <div class="stat-label">想看电影</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">{{ commentsCount }}</div>
                                <div class="stat-label">发表评论</div>
                            </div>
                        </div>

                        <div class="actions">
                            <button @click="goBack" class="back-button">返回首页</button>
                            <button @click="logout" class="logout-button">退出登录</button>
                        </div>
                    </div>
                </div>

                <h2 class="section-title">已看电影 ({{ watchedCount }})</h2>
                <div v-if="watchedMovies.length > 0" class="movies-grid">
                    <div v-for="movie in watchedMovies" :key="movie['电影编号']" class="movie-card"
                        @click="viewMovieDetail(movie['电影编号'])">
                        <img :src="getImagePath(movie['本地图片路径'])" :alt="movie['电影标题']" class="movie-poster"
                            @error="handleImageError">
                        <div class="movie-title">{{ movie['电影标题'] }}</div>
                    </div>
                </div>
                <div v-else>
                    <p>暂无已看电影</p>
                </div>

                <h2 class="section-title">想看电影 ({{ wantToWatchCount }})</h2>
                <div v-if="wantToWatchMovies.length > 0" class="movies-grid">
                    <div v-for="movie in wantToWatchMovies" :key="movie['电影编号']" class="movie-card"
                        @click="viewMovieDetail(movie['电影编号'])">
                        <img :src="getImagePath(movie['本地图片路径'])" :alt="movie['电影标题']" class="movie-poster"
                            @error="handleImageError">
                        <div class="movie-title">{{ movie['电影标题'] }}</div>
                    </div>
                </div>
                <div v-else>
                    <p>暂无想看电影</p>
                </div>
            </div>

            <div v-else class="error-container">
                <p>未找到用户信息，请先登录</p>
                <button @click="goBack" class="back-button">返回首页</button>
            </div>
        </div>
    </div>

    <script>
        const {
            createApp
        } = Vue;

        createApp({
            data() {
                return {
                    user: null,
                    movies: [],
                    comments: [],
                    loading: true,
                    error: null
                }
            },

            computed: {
                watchedCount() {
                    return this.user && this.user['watched_count'] ? parseInt(this.user['watched_count']) : 0;
                },

                wantToWatchCount() {
                    return this.user && this.user['want_to_watch_count'] ? parseInt(this.user['want_to_watch_count']) : 0;
                },

                commentsCount() {
                    if (!this.comments || !this.user) return 0;
                    return this.comments.filter(comment => comment['user_id'] == this.user['user_id']).length;
                },

                watchedMovies() {
                    if (!this.user || !this.movies) return [];

                    try {
                        // 解析已看电影列表
                        const watchedMovieIds = JSON.parse(this.user['watched_movie'].replace(/'/g, '"'));
                        return this.movies.filter(movie =>
                            watchedMovieIds.includes(parseInt(movie['电影编号']))
                        );
                    } catch (e) {
                        console.error('解析已看电影列表出错:', e);
                        return [];
                    }
                },

                wantToWatchMovies() {
                    if (!this.user || !this.movies) return [];

                    try {
                        // 解析想看电影列表
                        const wantToWatchMovieIds = JSON.parse(this.user['want_to_watch_movie'].replace(/'/g, '"'));
                        return this.movies.filter(movie =>
                            wantToWatchMovieIds.includes(parseInt(movie['电影编号']))
                        );
                    } catch (e) {
                        console.error('解析想看电影列表出错:', e);
                        return [];
                    }
                }
            },

            mounted() {
                // 从localStorage获取当前用户ID
                const currentUserId = localStorage.getItem('currentUserId');

                if (currentUserId) {
                    this.loadUserProfile(currentUserId);
                } else {
                    this.loading = false;
                    this.error = "未找到用户信息，请先登录";
                }
            },

            methods: {
                async loadUserProfile(userId) {
                    this.loading = true;
                    this.error = null;

                    try {
                        // 并行加载用户、电影和评论数据
                        const [usersResponse, moviesResponse, commentsResponse] = await Promise.all([
                            fetch('./user.csv'),
                            fetch('./movie_info.csv'),
                            fetch('./comment.csv')
                        ]);

                        const usersText = await usersResponse.text();
                        const moviesText = await moviesResponse.text();
                        const commentsText = await commentsResponse.text();

                        // 解析用户数据
                        const users = this.parseUsersCSV(usersText);
                        this.user = users.find(u => u['user_id'] == userId);

                        // 解析电影数据
                        this.movies = this.parseMoviesCSV(moviesText);

                        // 解析评论数据
                        this.comments = this.parseCommentsCSV(commentsText);

                        if (!this.user) {
                            this.error = `未找到ID为 "${userId}" 的用户`;
                        }
                    } catch (error) {
                        console.error('加载用户资料失败:', error);
                        this.error = `加载失败: ${error.message}`;
                    } finally {
                        this.loading = false;
                    }
                },

                parseUsersCSV(csvText) {
                    // 移除可能的BOM标记
                    if (csvText.charCodeAt(0) === 0xFEFF) {
                        csvText = csvText.slice(1);
                    }

                    const lines = this.splitCSVLines(csvText);
                    if (lines.length <= 1) return [];

                    // 解析标题行
                    const headers = this.parseCSVLine(lines[0]).map(h => h.trim());

                    // 解析数据行
                    const users = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line === '') continue;

                        try {
                            const values = this.parseCSVLine(line).map(v => v.trim());
                            if (values.length !== headers.length) continue;

                            const user = {};
                            headers.forEach((header, index) => {
                                user[header] = values[index] || '';
                            });

                            users.push(user);
                        } catch (e) {
                            console.log(`解析用户第${i + 1}行时出错:`, e);
                        }
                    }

                    return users;
                },

                parseMoviesCSV(csvText) {
                    // 移除可能的BOM标记
                    if (csvText.charCodeAt(0) === 0xFEFF) {
                        csvText = csvText.slice(1);
                    }

                    const lines = this.splitCSVLines(csvText);
                    if (lines.length <= 1) return [];

                    // 解析标题行
                    const headers = this.parseCSVLine(lines[0]).map(h => h.trim());

                    // 解析数据行
                    const movies = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line === '') continue;

                        try {
                            const values = this.parseCSVLine(line).map(v => v.trim());
                            if (values.length !== headers.length) continue;

                            const movie = {};
                            headers.forEach((header, index) => {
                                movie[header] = values[index] || '';
                            });

                            movies.push(movie);
                        } catch (e) {
                            console.log(`解析电影第${i + 1}行时出错:`, e);
                        }
                    }

                    return movies;
                },

                parseCommentsCSV(csvText) {
                    // 移除可能的BOM标记
                    if (csvText.charCodeAt(0) === 0xFEFF) {
                        csvText = csvText.slice(1);
                    }

                    const lines = this.splitCSVLines(csvText);
                    if (lines.length <= 1) return [];

                    // 解析标题行
                    const headers = this.parseCSVLine(lines[0]);

                    // 解析数据行
                    const comments = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line === '') continue;

                        try {
                            const values = this.parseCSVLine(line);
                            if (values.length !== headers.length) continue;

                            const comment = {};
                            // 正确映射字段名和值
                            headers.forEach((header, index) => {
                                // 移除可能的BOM标记和空格
                                const cleanHeader = header.replace(/^\uFEFF/, '').trim();
                                const value = values[index] ? values[index].toString().trim() : '';

                                // 对特定字段进行处理
                                if (cleanHeader === 'rating') {
                                    comment[cleanHeader] = parseInt(value) || 0;
                                } else if (['movie_id', 'user_id', 'comment_id'].includes(cleanHeader)) {
                                    comment[cleanHeader] = value;
                                } else {
                                    comment[cleanHeader] = value;
                                }
                            });

                            comments.push(comment);
                        } catch (e) {
                            console.log(`解析评论第${i + 1}行时出错:`, e);
                        }
                    }

                    return comments;
                },

                parseCSVLine(line) {
                    const result = [];
                    let current = '';
                    let inQuotes = false;

                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];

                        if (char === '"') {
                            // 检查是否是转义的引号
                            if (i + 1 < line.length && line[i + 1] === '"') {
                                current += '"';
                                i++; // 跳过下一个引号
                            } else {
                                inQuotes = !inQuotes;
                            }
                        } else if (char === ',' && !inQuotes) {
                            result.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }

                    result.push(current);
                    return result;
                },

                splitCSVLines(text) {
                    const lines = [];
                    let currentLine = '';
                    let inQuotes = false;

                    for (let i = 0; i < text.length; i++) {
                        const char = text[i];

                        if (char === '"') {
                            // 检查是否是转义的引号
                            if (i + 1 < text.length && text[i + 1] === '"') {
                                currentLine += '""';
                                i++; // 跳过下一个引号
                                continue;
                            } else {
                                inQuotes = !inQuotes;
                            }
                        } else if (char === '\n' && !inQuotes) {
                            lines.push(currentLine);
                            currentLine = '';
                            continue;
                        }

                        currentLine += char;
                    }

                    // 添加最后一行（如果没有以换行符结尾）
                    if (currentLine) {
                        lines.push(currentLine);
                    }

                    return lines;
                },

                getImagePath(imagePath) {
                    if (imagePath && typeof imagePath === 'string') {
                        // 移除可能的BOM标记
                        if (imagePath.charCodeAt(0) === 65279) {
                            imagePath = imagePath.substring(1);
                        }

                        // 清理路径，移除多余的引号
                        imagePath = imagePath.replace(/(^["'])|(["']$)/g, '');

                        // 确保路径正确
                        if (imagePath.startsWith('img/')) {
                            return `/${imagePath}`;
                        } else if (!imagePath.startsWith('/')) {
                            return `/img/${imagePath}`;
                        }
                        return imagePath;
                    }
                    return '/img/default_movie.jpg'; // 默认图片路径
                },

                handleImageError(event) {
                    // 图片加载失败时使用默认图片
                    event.target.src = '/img/default_movie.jpg';
                },

                goBack() {
                    window.location.href = './';
                },

                logout() {
                    // 清除用户登录信息
                    localStorage.removeItem('currentUserId');
                    // 跳转到首页
                    window.location.href = './';
                },

                retry() {
                    const currentUserId = localStorage.getItem('currentUserId');
                    if (currentUserId) {
                        this.loadUserProfile(currentUserId);
                    }
                },

                viewMovieDetail(movieId) {
                    window.location.href = `./movie-detail.html?id=${movieId}`;
                }
            }
        }).mount('#app');
    </script>
</body>

</html>